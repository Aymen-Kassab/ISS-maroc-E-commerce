<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Commander Produit</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="stylesheet" href="css_client/client_purshace.css">
  </head>
  <body>

    <header class="header">
      <div class="header-container">
        <a href="client_home.html" class="logo"><img class="logo-img" src="logo/image.png" alt=""></a>
        <div class="header-icons">
          <a href="client_cart.html"><button class="icon-btn">
            <i class="fas fa-shopping-cart"></i>
            <span class="cart-badge">0</span>
          </button></a>
        </div>
      </div>
    </header>

    <main class="content-area">
      <div class="product-details-card">
        
      </div>
    </main>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const params = new URLSearchParams(window.location.search);
        const productId = params.get("id");
        const container = document.querySelector(".product-details-card");

        if (!productId) {
          container.innerHTML = `<div class="error">Produit non spécifié.</div>`;
          return;
        }

        fetch(`http://localhost:8080/api/printer/${productId}`)
        .then(res => {
          if (!res.ok) throw new Error("Erreur lors du chargement du produit.");
          return res.json();
        })
        .then(product => {
          if (!product) {
            container.innerHTML = `<div class="error">Produit introuvable.</div>`;
            return;
          }

          // Prepare image url (first one or placeholder)
          let imageUrl = "https://via.placeholder.com/600x400";
          if (product.imageUrls && product.imageUrls.length > 0) {
            imageUrl = product.imageUrls[0].startsWith("http") ? product.imageUrls[0] : `http://localhost:8080${product.imageUrls[0]}`;
          }

          // Prepare badge category with a lowercase class safe for CSS
          const badgeClass = product.category ? product.category.toLowerCase().replace(/\s+/g, '-') : "";

          // Build specs string with highlights
          const specs = [
              product.printSpeed,
              product.resolution,
              product.workCycle,
              product.rectoVerso,
              product.connectivity
          ].filter(Boolean).map(spec => `<span class="spec-highlight">${spec}</span>`).join(" | ");

          container.innerHTML = `
            <div class="product-details-grid">

              <div class="product-details-info">
                <p class="product-category">${product.brand}</p>
                <h2 class="product-title">${product.name}</h2>

                <p class="product-specs">
                  Vitesse d'impression :<span class="spec-highlight">${product.printSpeed}</span><br>
                  Qualité d'impression :<span class="spec-highlight">${product.resolution} </span><br>
                  Impression recto/verso :<span class="spec-highlight">${product.rectoVerso}</span><br>
                  Connectivité :<span class="spec-highlight">${product.connectivity}</span><br>
                  Stock :<span class="spec-highlight">${product.stock}</span>
                </p>

                <div class="product-price">
                  <span class="price-current">${product.price} DH</span>
                </div>
                <form id="order-form" class="order-form">
                  <h3>Commander ce produit</h3>
                  <div class="form-group">
                    <label for="fullName">Nom Complet:</label>
                    <input type="text" id="fullName" name="fullName" required placeholder="Votre nom complet">
                  </div>
                  <div class="form-group">
                    <label for="phone">Numéro de Téléphone:</label>
                    <input type="tel" id="phone" name="phone" required placeholder="06 12 34 56 78">
                  </div>
                  <div class="form-group">
                    <label for="quantity">Quantité:</label>
                    <input type="number" id="quantity" name="quantity" required >
                  </div>
                  <div class="form-group">
                    <label for="address">Adresse:</label>
                    <textarea id="address" name="address" required placeholder="Votre adresse complète"></textarea>
                  </div>
                  <button type="submit" class="btn-primary">Passer la commande</button>
                </form>

              </div>

            </div>
          `;

          document.getElementById("order-form").addEventListener("submit", async function (e) {
            e.preventDefault();

            const quantity = parseInt(document.getElementById("quantity").value);

            const orderValues = {
                fullName: document.getElementById("fullName").value,
                phoneNumber: document.getElementById("phone").value,
                quantity: quantity,
                address: document.getElementById("address").value,
                productName: product.name,
                price: product.price * quantity,
                date: new Date().toISOString().split('T')[0],
                status: "pending"
            }

            try{
                const response = await fetch('http://localhost:8080/api/command', {
                    method: 'POST',
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify(orderValues),
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'Request failed');
                }

                const result = await response.json();
                console.log("Success:", result);
                alert("Commande passée avec succès!");
                this.reset();
            }catch (error) {
                console.error("Error:", error);
                alert("Erreur: " + error.message);
            }
          });
        })
        .catch(error => {
        container.innerHTML = `<div class="error">Erreur: ${error.message}</div>`;
        console.error(error);
        });
      });
      function getCartProductCount() {
          const cart = JSON.parse(localStorage.getItem("cart")) || [];
          let total = 0;

          for (let item of cart) {
              total += item.quantity;
          }

          return total;
      }

      document.querySelector(".cart-badge").innerText = getCartProductCount();
    </script>
  </body>
</html>