<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Product Details</title>
        <link rel="stylesheet" href="css_client/client_pro_det.css" />
        <link rel="icon" type="image/png" href="logo/images.png">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    </head>
    <body>

        <header class="header">
            <div class="header-container">
            <a href="client_home.html" class="logo"><img class="logo-img" src="logo/image.png" alt=""></a>
            <div class="header-icons">
                <a href="client_cart.html"><button class="icon-btn">
                <i class="fas fa-shopping-cart"></i>
                <span class="cart-badge">0</span>
                </button></a>
            </div>
            </div>
        </header>

        <main class="content-area">
            <div class="product-details-card">
            <div class="product-details-grid">


            </div>
            </div>
        </main>
        <div id="popupMessage" style="
            display: none;
            position: fixed;
            top: 100px;      
            left: 50%;   
            transform: translateX(-50%);  
            background-color: #4caf50;
            color: white;
            padding: 12px 20px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
            font-weight: bold;
            z-index: 9999;
            opacity: 1;
            transition: opacity 0.5s ease-in-out;
        "></div>
        <script>
            document.addEventListener("DOMContentLoaded", () => {
            const params = new URLSearchParams(window.location.search);
            const productId = params.get("id");
            const container = document.querySelector(".product-details-card");

            if (!productId) {
                container.innerHTML = `<div class="error">Produit non spécifié.</div>`;
                return;
            }

            fetch(`https://isswebproject-production.up.railway.app/api/computers/${productId}`)
                .then(res => {
                if (!res.ok) throw new Error("Erreur lors du chargement du produit.");
                return res.json();
                })
                .then(product => {
                if (!product) {
                    container.innerHTML = `<div class="error">Produit introuvable.</div>`;
                    return;
                }

                // Prepare image url (first one or placeholder)
                let imageUrl = "https://via.placeholder.com/600x400";
                if (product.imageUrls && product.imageUrls.length > 0) {
                    imageUrl = product.imageUrls[0].startsWith("http")
                    ? product.imageUrls[0]
                    : `https://isswebproject-production.up.railway.app${product.imageUrls[0]}`;
                }

                // Prepare badge category with a lowercase class safe for CSS
                const badgeClass = product.category ? product.category.toLowerCase().replace(/\s+/g, '-') : "";

                product.description = `
                    <strong>Nom :</strong> ${product.name || 'Non spécifié'}<br>
                    <strong>Processeur :</strong> ${product.processor || 'Non spécifié'}<br>
                    <strong>Mémoire RAM :</strong> ${product.memory || 'Non spécifié'}<br>
                    <strong>Stockage :</strong> ${product.storage || 'Non spécifié'}<br>
                    <!-- <strong>Carte Graphique :</strong> ${product.graphicsCard || 'Non spécifiée'}<br> -->
                    <strong>Catégorie :</strong> ${product.type || 'Non spécifiée'}<br>
                `;

                container.innerHTML = `
                    <div class="product-details-grid">

                    <!-- Product Image -->
                    <div class="product-image-large">
                        <img src="${imageUrl}" alt="${product.name || 'Produit'}" />
                        ${product.category ? `<span class="product-badge ${badgeClass}">${product.category}</span>` : ''}
                    </div>

                    <!-- Product Info -->
                    <div class="product-details-info">
                        <p class="product-category">${product.type || ''}</p>
                        <h2 class="product-title">${product.name || ''}</h2>

                        <div class="product-price">
                        <span class="price-current">${product.price} DH</span>
                        ${product.oldPrice ? `<span class="price-old">${product.oldPrice} DH</span>` : ''}
                        </div>

                        <div class="product-actions">
                        <button class="btn-primary">Ajouter au panier</button>
                        <button class="btn-secondary" onclick="buyNow(${product.id})">Acheter maintenant</button>
                        </div>
                        <div class="product-description">
                        <h3>Description</h3>
                        <p>${product.description || 'Description non disponible.'}</p>
                        </div>
                    </div>

                    </div>
                `;
                document.querySelector(".btn-primary").addEventListener("click", (e) => {
                            e.stopPropagation(); 
                            addToCart(product, imageUrl);
                        });

                document.querySelector(".btn-secondary").addEventListener("click", (e) => {
                    e.preventDefault();
                    window.location.href = `/client_comp_purchase.html?id=${product.id}`;
                });

                function addToCart(computer, imageUrl) {
                    const cart = JSON.parse(localStorage.getItem("cart")) || [];

                    const existingItem = cart.find(item => item.id === computer.id && item.category === "computer");

                    if (existingItem) {
                        existingItem.quantity += 1;
                    } else {
                        cart.push({
                            id: computer.id,
                            name: computer.name,
                            category: 'Ordinateur',
                            price: computer.price,
                            description: `${computer.brand} || ${computer.processor} || ${computer.memory} || ${computer.storage} ${computer.storageType}`,
                            quantity: 1,
                            image: imageUrl,
                            addedAt: Date.now()
                        });
                    }

                    localStorage.setItem("cart", JSON.stringify(cart));
                    showPopupMessage("Produit ajouté au panier !");
                    
                }

                function showPopupMessage(message, duration = 3000) {
                    const popup = document.getElementById('popupMessage');
                    popup.textContent = message;
                    popup.style.display = 'block';
                    popup.style.opacity = '1';

                    // Hide after duration ms with fade effect
                    setTimeout(() => {
                        popup.style.opacity = '0';
                        // After transition ends, hide completely
                        setTimeout(() => {
                            popup.style.display = 'none';
                        }, 500); // matches CSS transition time
                    }, duration);
                }
            
                })
                .catch(error => {
                container.innerHTML = `<div class="error">Erreur: ${error.message}</div>`;
                console.error(error);
                });
            });

            function getCartProductCount() {
                const cart = JSON.parse(localStorage.getItem("cart")) || [];
                let total = 0;

                for (let item of cart) {
                    total += item.quantity;
                }

                return total;
            }

            document.querySelector(".cart-badge").innerText = getCartProductCount();
        </script>
    </body>
</html>