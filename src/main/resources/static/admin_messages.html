<!DOCTYPE html>
<html lang="fr">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ISS MAROC - Gestion des Messages</title>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
        <link rel="stylesheet" href="css_admin/admin_message.css">
    </head>
    <body>
        <!-- Sidebar Overlay -->
        <div class="sidebar-overlay" id="sidebarOverlay"></div>

        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="#" class="sidebar-logo">
                    <i class="fas fa-store"></i>
                    ISS MAROC
                </a>
            </div>
            
            <nav class="sidebar-nav">
                <div class="nav-item">
                    <a href="admin_home.html" class="nav-link">
                        <i class="fas fa-home"></i>
                        <span>Accueil</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="admin_news.html" class="nav-link">
                        <i class="fas fa-star"></i>
                        <span>Nouveautés</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="admin_computer.html" class="nav-link">
                        <i class="fas fa-laptop"></i>
                        <span>Ordinateurs</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="admin_printer.html" class="nav-link">
                        <i class="fas fa-print"></i>
                        <span>Imprimantes</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="admin_network.html" class="nav-link">
                        <i class="fas fa-network-wired"></i>
                        <span>Réseaux</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="admin_command.html" class="nav-link">
                        <i class="fas fa-shopping-cart"></i>
                        <span>Commandes</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="#" class="nav-link active">
                        <i class="fas fa-envelope"></i>
                        <span>Messages</span>
                    </a>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content" id="mainContent">
            <!-- Top Header -->
            <header class="top-header">
                <div class="header-left">
                    <button class="mobile-toggle" id="mobileToggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1 class="page-title" id="pageTitle">Gestion des Messages</h1>
                </div>
                <div class="header-right">
                    <div class="user-profile">
                        <div class="user-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <span class="user-name">Admin</span>
                    </div>
                </div>
            </header>

            <!-- Dashboard Content -->
            <div class="dashboard-content" id="dashboardContent">
                <!-- Messages Section -->
                <div class="messages-section">
                    <!-- Statistics Cards -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon new">
                                <i class="fas fa-envelope"></i>
                            </div>
                            <div class="stat-number" id="unread"></div>
                            <div class="stat-label">Nouveaux Messages</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon read">
                                <i class="fas fa-envelope-open"></i>
                            </div>
                            <div class="stat-number" id="read"></div>
                            <div class="stat-label">Messages Lus</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon archived">
                                <i class="fas fa-archive"></i>
                            </div>
                            <div class="stat-number" id="archived"></div>
                            <div class="stat-label">Messages Archivés</div>
                        </div>
                    </div>

                    <!-- Messages Management -->
                    <div class="section-card">
                        <div class="card-header">
                            <h2><i class="fas fa-inbox"></i> Boîte de Réception</h2>
                            <p>Gérez tous les messages de vos clients avec possibilité de réponse et d'archivage</p>
                        </div>
                        
                        <div class="card-content">
                            <!-- Search and Filter Controls -->
                            <div class="messages-controls">
                                <div class="search-box">
                                    <i class="fas fa-search search-icon"></i>
                                    <input type="text" class="search-input" placeholder="Rechercher par nom, email, sujet..." id="searchInput">
                                </div>
                                <select class="filter-select" id="statusFilter">
                                    <option value="">Tous les statuts</option>
                                    <option value="new">Nouveaux</option>
                                    <option value="read">Lus</option>
                                    <option value="replied">Répondus</option>
                                    <option value="archived">Archivés</option>
                                </select>
                                <select class="filter-select" id="priorityFilter">
                                    <option value="">Toutes priorités</option>
                                    <option value="high">Priorité Haute</option>
                                    <option value="medium">Priorité Moyenne</option>
                                    <option value="low">Priorité Basse</option>
                                </select>
                                <select class="filter-select" id="dateFilter">
                                    <option value="">Toutes les dates</option>
                                    <option value="today">Aujourd'hui</option>
                                    <option value="week">Cette semaine</option>
                                    <option value="month">Ce mois</option>
                                </select>
                            </div>

                            <!-- Messages Grid -->
                            <div class="messages-grid" id="messagesGrid">
                                
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        <script>
            document.addEventListener("DOMContentLoaded", function() {
                loadMessages();
            });

            function loadMessages() {
                fetch("http://localhost:8080/api/contact")
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById("messagesGrid");
                    container.innerHTML = "";

                    let read = 0;
                    let unread = 0;
                    let archived = 0;


                    data.forEach(comp => {
                        if (comp.status === "read") read++;
                        else if (comp.status === "unread") unread++;
                        else if (comp.status === "archived") archived++;

                        renderMessages(comp, container);
                    });

                    document.getElementById("read").innerText = read;
                    document.getElementById("unread").innerText = unread;
                    document.getElementById("archived").innerText = archived;
                })
                .catch(error => {
                    console.error("Erreur lors du chargement :", error);
                });    
            }
            
            function renderMessages(comp, container){
                const messageCard = document.createElement('div');
                messageCard.classList.add("message-card");
                if (comp.status) messageCard.classList.add(comp.status);
                messageCard.setAttribute("data-status", comp.status);

                let priority = "";

                switch(comp.status){
                    case "unread" : messageCard.setAttribute("data-priority", "high");
                                    priority = "high";
                    break;
                    case "read" : messageCard.setAttribute("data-priority", "medium");
                                  priority = "medium";
                    break;
                    case "archived" : messageCard.setAttribute("data-priority", "low");
                                      priority = "low";
                    break;
                }

                messageCard.innerHTML = `
                    <div class="message-header">
                        <div class="message-info">
                            <div class="client-name">${comp.firstName} ${comp.lastName}</div>
                            <div class="contact-info">
                                <div class="contact-item">
                                    <i class="fas fa-envelope"></i>
                                    <span>${comp.email}</span>
                                </div>
                                <div class="contact-item">
                                    <i class="fas fa-phone"></i>
                                    <span>${comp.phoneNumber}</span>
                                </div>
                            </div>
                            <div class="message-subject">${comp.subject}</div>
                            <div class="message-date"></div>
                        </div>
                        <div class="message-status">
                            <span class="status-badge ${comp.status}">${comp.status}</span>
                            <span class="priority-badge ${priority}">Priorité ${priority}</span>
                        </div>
                    </div>
                    <div class="message-content">
                        <div class="message-text">
                            ${comp.message}
                        </div>
                        <div class="message-actions">
                            <button class="action-btn mark-read">
                                <i class="fas fa-check"></i> Marquer comme lu
                            </button>
                            <button class="action-btn archive">
                                <i class="fas fa-archive"></i> Archiver
                            </button>
                            <button class="action-btn delete">
                                <i class="fas fa-trash"></i> Supprimer
                            </button>
                        </div>
                    </div>
                `;
                    
                container.appendChild(messageCard);

                messageCard.querySelector(".delete").addEventListener("click", () => deleteMessage(comp.id));
                messageCard.querySelector(".archive").addEventListener("click", () => archMessage(comp.id));
                messageCard.querySelector(".mark-read").addEventListener("click", () => markReadMessage(comp.id));

            }

            function deleteMessage(id){
                if(confirm("Voulez-vous vraiment supprimer ce message?")){
                    fetch(`http://localhost:8080/api/contact/${id}`, {
                        method: 'DELETE'
                    })
                    .then(response => {
                        if(response.ok){
                            loadMessages();
                            alert("Message supprimé avec succès!");
                        }
                        else {
                            throw new Error("Error de la supression!");
                            loadMessages();
                        }
                    })
                    .catch(error => {
                        console.error("Error:", error);
                        alert("Erreur lors de la suppression");
                        loadMessages();
                    });
                }
            }

            async function markReadMessage(Id) {
                try {
                    const response = await fetch(`http://localhost:8080/api/contact/${Id}/status`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ status: "read" })
                    });

                    if (!response.ok) {
                        throw new Error("Failed to update status");
                    }

                    const result = await response.json();
                    alert("Status updated to: " + result.status);
                } catch (error) {
                        console.error("Error updating status:", error);
                }
                loadMessages();
            }
            
            async function archMessage(Id) {
                try {
                    const response = await fetch(`http://localhost:8080/api/contact/${Id}/status`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ status: "archived" })
                    });

                    if (!response.ok) {
                        throw new Error("Failed to update status");
                    }

                    const result = await response.json();
                    alert("Status updated to: " + result.status);
                } catch (error) {
                        console.error("Error updating status:", error);
                }

                loadMessages();
            }
        </script>
        <script src="js_admin/admin_message.js"></script>
    </body>
</html>