<!DOCTYPE html>
<html lang="fr">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ISS MAROC - Gestion des Commandes</title>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
        <link rel="stylesheet" href="css_admin/admin_command.css">
    </head>
    <body>
        <div class="sidebar-overlay" id="sidebarOverlay"></div>

        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="#" class="sidebar-logo">
                    <i class="fas fa-store"></i>
                    ISS MAROC
                </a>
            </div>
            
            <nav class="sidebar-nav">
                <div class="nav-item">
                    <a href="admin_home.html" class="nav-link">
                        <i class="fas fa-home"></i>
                        <span>Accueil</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="admin_news.html" class="nav-link">
                        <i class="fas fa-star"></i>
                        <span>Nouveautés</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="admin_computer.html" class="nav-link">
                        <i class="fas fa-laptop"></i>
                        <span>Ordinateurs</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="admin_printer.html" class="nav-link">
                        <i class="fas fa-print"></i>
                        <span>Imprimantes</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="admin_network.html" class="nav-link">
                        <i class="fas fa-network-wired"></i>
                        <span>Réseaux</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="#" class="nav-link active">
                        <i class="fas fa-shopping-cart"></i>
                        <span>Commandes</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="admin_messages.html" class="nav-link">
                        <i class="fas fa-envelope"></i>
                        <span>Messages</span>
                    </a>
                </div>
            </nav>
        </aside>

        <main class="main-content" id="mainContent">
            <header class="top-header">
                <div class="header-left">
                    <button class="mobile-toggle" id="mobileToggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1 class="page-title" id="pageTitle">Gestion des Commandes</h1>
                </div>
                <div class="header-right">
                    <div class="user-profile">
                        <form id="logoutForm" action="/logout" method="post" style="display:none;">
                            <input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}" />
                        </form>
                        <button class="logout" onclick="document.getElementById('logoutForm').submit();">Se déconnecter</button>
                    </div>
                </div>
            </header>

            <div class="dashboard-content" id="dashboardContent">
                
                <div class="orders-section">
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon pending">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div class="stat-number"></div>
                            <div class="stat-label">En Attente</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon confirmed">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <div class="stat-number"></div>
                            <div class="stat-label">Confirmées</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon shipped">
                                <i class="fas fa-shipping-fast"></i>
                            </div>
                            <div class="stat-number"></div>
                            <div class="stat-label">Expédiées</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon delivered">
                                <i class="fas fa-box-open"></i>
                            </div>
                            <div class="stat-number"></div>
                            <div class="stat-label">Livrées</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon canceled">
                                <i class="fas fa-times-circle"></i>
                            </div>
                            <div class="stat-number"></div>
                            <div class="stat-label">Annulées</div>
                        </div>
                    </div>

                    <div class="section-card">
                        <div class="card-header">
                            <h2><i class="fas fa-list"></i> Liste des Commandes</h2>
                            <p>Gérez toutes les commandes de vos clients avec possibilité de modification du statut</p>
                        </div>
                        
                        <div class="card-content">
                            <div class="orders-controls">
                                <div class="search-box">
                                    <i class="fas fa-search search-icon"></i>
                                    <input type="text" class="search-input" placeholder="Rechercher par nom client, téléphone, produit..." id="searchInput">
                                </div>
                                <select class="filter-select" id="statusFilter">
                                    <option value="">Tous les statuts</option>
                                    <option value="pending">En Attente</option>
                                    <option value="confirmed">Confirmée</option>
                                    <option value="shipped">Expédiée</option>
                                    <option value="delivered">Livrée</option>
                                    <option value="canceled">Annulée</option>
                                </select>
                                <select class="filter-select" id="dateFilter">
                                    <option value="">Toutes les dates</option>
                                    <option value="today">Aujourd'hui</option>
                                    <option value="week">Cette semaine</option>
                                    <option value="month">Ce mois</option>
                                </select>
                            </div>

                            <div class="orders-table-container">
                                <table class="orders-table" id="ordersTable">
                                    <thead>
                                        <tr>
                                            <th>N° Commande</th>
                                            <th>Client</th>
                                            <th>Produit(s)</th>
                                            <th>Total</th>
                                            <th>Date</th>
                                            <th>Statut</th>
                                            <th>Adresse</th>
                                        </tr>
                                    </thead>
                                    <tbody id="command-container">
                                        
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        <script>
            document.addEventListener("DOMContentLoaded", function() {
                loadCommands();
            });

            // 1. Fixed loadCommands function
            function loadCommands() {
                fetch("https://isswebproject-production.up.railway.app/api/command/sorted-by-id")
                .then(response => {
                    if (!response.ok) throw new Error("Failed to load commands");
                    return response.json();
                })
                .then(commands => {
                    const container = document.getElementById("command-container");
                    if (!container) {
                        console.error("Container element not found");
                        return;
                    }
                    
                    container.innerHTML = "";
                    
                    commands.forEach(command => {
                        renderCommand(command, container);
                    });
                    
                    updateStats(commands); // Use the correct function name
                })
                .catch(error => {
                    console.error("Error:", error);
                    alert("Error loading commands: " + error.message);
                });
            }

            // 2. Fixed stats update function (renamed to avoid confusion)
            function updateStats(commands = []) {
                const counts = {
                    pending: 0,
                    confirmed: 0,
                    shipped: 0,
                    delivered: 0,
                    canceled: 0
                };
                
                commands.forEach(cmd => {
                    if (cmd && cmd.status && counts.hasOwnProperty(cmd.status)) {
                        counts[cmd.status]++;
                    }
                });
                
                // Update stats display
                Object.entries(counts).forEach(([status, count], index) => {
                    const statElement = document.querySelector(`.stat-card:nth-child(${index + 1}) .stat-number`);
                    if (statElement) statElement.textContent = count;
                });
            }

            // 3. Fixed render function with proper event binding
            function renderCommand(command, container) {
                const commandRow = document.createElement('tr');
                commandRow.setAttribute("data-status", command.status);
                commandRow.setAttribute("data-command-id", command.id);

                const orderDate = new Date(command.date).toLocaleDateString('fr-FR');
                
                commandRow.innerHTML = `
                    <td class="order-id">#${command.id}</td>
                    <td>
                        <div class="client-info">
                            <span class="client-name">${command.fullName}</span>
                            <span class="client-phone">${command.phoneNumber}</span>
                        </div>
                    </td>
                    <td>
                        <div class="product-info">
                            <span class="product-name">${command.productName}</span>
                            <span class="product-quantity">Quantité: ${command.quantity}</span>
                        </div>
                    </td>
                    <td class="order-total">${command.price} DH</td>
                    <td class="order-date">${orderDate}</td>
                    <td>
                        <select class="status-select ${command.status}">
                            <option value="pending" ${command.status === 'pending' ? 'selected' : ''}>En Attente</option>
                            <option value="confirmed" ${command.status === 'confirmed' ? 'selected' : ''}>Confirmée</option>
                            <option value="shipped" ${command.status === 'shipped' ? 'selected' : ''}>Expédiée</option>
                            <option value="delivered" ${command.status === 'delivered' ? 'selected' : ''}>Livrée</option>
                            <option value="canceled" ${command.status === 'canceled' ? 'selected' : ''}>Annulée</option>
                        </select>
                    </td>
                    <td class="address">${command.address}</td>
                `;

                // Proper event binding
                const selectElement = commandRow.querySelector('.status-select');
                selectElement.addEventListener('change', function() {
                    updateOrderStatus(this);
                });
                
                container.appendChild(commandRow);
            }

            // 4. Completely rewritten update function
            async function updateOrderStatus(selectElement) {
                const newStatus = selectElement.value;
                const row = selectElement.closest('tr');
                const commandId = row.dataset.commandId;
                const originalStatus = row.dataset.status;

                console.log(`Updating command ${commandId} from ${originalStatus} to ${newStatus}`);

                try {
                    // Lock UI during update
                    selectElement.disabled = true;
                    row.classList.add('updating');

                    const response = await fetch(`https://isswebproject-production.up.railway.app/api/command/${commandId}/status`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify({ status: newStatus })
                    });

                    console.log('Response status:', response.status);

                    if (!response.ok) {
                        const error = await response.text();
                        throw new Error(error || `HTTP error! status: ${response.status}`);
                    }

                    // Update UI on success
                    row.dataset.status = newStatus;
                    selectElement.className = `status-select ${newStatus}`;
                    row.classList.add('updated');
                    
                    // Update statistics
                    const commands = await fetch("https://isswebproject-production.up.railway.app/api/command").then(res => res.json());
                    updateStats(commands);
                    
                } catch (error) {
                    console.error("Update failed:", error);
                    selectElement.value = originalStatus;
                    alert(`Échec de la mise à jour: ${error.message}`);
                } finally {
                    selectElement.disabled = false;
                    row.classList.remove('updating');
                    setTimeout(() => row.classList.remove('updated'), 2000);
                }
            }
        </script>
        <script src="js_admin/admin_command.js"></script>
    </body>
</html>